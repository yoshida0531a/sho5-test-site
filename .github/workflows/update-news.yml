name: Update News with AI Summary

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger

jobs:
  update-news:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Fetch and summarize news
        env:
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
        run: |
          python3 << 'EOF'
          import json
          import requests
          import re
          import os
          from datetime import datetime, timedelta
          
          # Debug: Check if API key is available
          api_key = os.environ.get('HF_API_KEY', '')
          print(f"API Key available: {'Yes' if api_key else 'No'}")
          print(f"API Key length: {len(api_key) if api_key else 0}")
          
          # Hugging Face API settings
          HF_API_URL = "https://api-inference.huggingface.co/models/facebook/bart-large-cnn"
          HF_HEADERS = {"Authorization": f"Bearer {api_key}"}
          
          def clean_text(text):
              # Remove HTML tags and clean text
              text = re.sub(r'<[^>]+>', '', text)
              text = re.sub(r'\s+', ' ', text).strip()
              return text[:500]  # Limit length for API
          
          def summarize_with_hf(text):
              try:
                  print(f"Attempting to summarize text: {text[:50]}...")
                  response = requests.post(
                      HF_API_URL,
                      headers=HF_HEADERS,
                      json={"inputs": text, "parameters": {"max_length": 100, "min_length": 30}},
                      timeout=30
                  )
                  print(f"API Response Status: {response.status_code}")
                  
                  if response.status_code == 200:
                      result = response.json()
                      print(f"API Response: {result}")
                      if isinstance(result, list) and len(result) > 0:
                          return result[0].get('summary_text', text[:100] + '...')
                  else:
                      print(f"API Error Response: {response.text}")
                  return text[:100] + '...'  # Fallback
              except Exception as e:
                  print(f"Exception in summarize_with_hf: {e}")
                  return text[:100] + '...'  # Fallback
          
          # Sample news data (replace with actual RSS parsing)
          sample_news = [
              {
                  "title": "ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼æ¥­ç•Œã®æœ€æ–°å‹•å‘ã«ã¤ã„ã¦",
                  "original_content": "ä»Šå¹´ã®ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼æ¥­ç•Œã§ã¯ã€AIæŠ€è¡“ã®ç™ºå±•ãŒç›®è¦šã¾ã—ãã€ç‰¹ã«è‡ªç„¶è¨€èªå‡¦ç†åˆ†é‡ã§ã®é©æ–°ãŒç¶šã„ã¦ã„ã¾ã™ã€‚å¤šãã®ä¼æ¥­ãŒAIã‚’æ´»ç”¨ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’å±•é–‹ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Šã‚’å›³ã£ã¦ã„ã¾ã™ã€‚",
                  "link": "#",
                  "pubDate": datetime.now().isoformat()
              },
              {
                  "title": "æŒç¶šå¯èƒ½ãªé–‹ç™ºã¸ã®å–ã‚Šçµ„ã¿",
                  "original_content": "ç’°å¢ƒå•é¡Œã¸ã®é–¢å¿ƒãŒé«˜ã¾ã‚‹ä¸­ã€å¤šãã®çµ„ç¹”ãŒæŒç¶šå¯èƒ½ãªé–‹ç™ºç›®æ¨™ã®é”æˆã«å‘ã‘ãŸå–ã‚Šçµ„ã¿ã‚’å¼·åŒ–ã—ã¦ã„ã¾ã™ã€‚å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®åˆ©ç”¨æ‹¡å¤§ã‚„ã€å¾ªç’°å‹çµŒæ¸ˆã®å®Ÿç¾ã«å‘ã‘ãŸæ–½ç­–ãŒé€²ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚",
                  "link": "#", 
                  "pubDate": datetime.now().isoformat()
              }
          ]
          
          # Process news with AI summary
          processed_news = []
          for article in sample_news:
              summary = summarize_with_hf(article["original_content"])
              
              processed_article = {
                  "title": article["title"],
                  "summary": summary,
                  "link": article["link"],
                  "pubDate": article["pubDate"],
                  "processed_at": datetime.now().isoformat()
              }
              processed_news.append(processed_article)
          
          # Save processed news
          with open('news-data.json', 'w', encoding='utf-8') as f:
              json.dump(processed_news, f, ensure_ascii=False, indent=2)
          
          print(f"Processed {len(processed_news)} articles")
          EOF
          
      - name: Update news.html
        run: |
          python3 << 'EOF'
          import json
          from datetime import datetime
          
          # Load processed news
          with open('news-data.json', 'r', encoding='utf-8') as f:
              news_data = json.load(f)
          
          # Generate news items HTML
          news_items = ""
          for article in news_data:
              try:
                  # Handle datetime parsing more robustly
                  pub_date_str = article["pubDate"]
                  if 'T' in pub_date_str:
                      # Remove microseconds and timezone info for simpler parsing
                      pub_date_str = pub_date_str.split('.')[0]
                      if '+' in pub_date_str:
                          pub_date_str = pub_date_str.split('+')[0]
                      if 'Z' in pub_date_str:
                          pub_date_str = pub_date_str.replace('Z', '')
                      pub_date = datetime.fromisoformat(pub_date_str)
                  else:
                      pub_date = datetime.now()
                  formatted_date = pub_date.strftime('%Yå¹´%mæœˆ%dæ—¥')
              except Exception as e:
                  print(f"Date parsing error for {article['pubDate']}: {e}")
                  formatted_date = datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')
              
              news_items += f'''
          <div class="news-item">
            <h3><a href="{article["link"]}" target="_blank">{article["title"]}</a></h3>
            <p class="date">{formatted_date}</p>
            <p class="summary">{article["summary"]}</p>
          </div>'''
          
          # Update news.html template
          html_template = f'''<!DOCTYPE html>
          <html lang="ja">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Newsroom - Shogo Fun Site</title>
            <style>
              * {{ margin: 0; padding: 0; box-sizing: border-box; }}
              body {{ font-family: sans-serif; background: white; color: black; }}
              header {{ text-align: center; font-size: 28px; font-weight: bold; margin: 20px 0; }}
              
              .news-feed {{
                width: calc(100% - 20px);
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
              }}
              
              @media (max-width: 600px) {{
                .news-feed {{ width: 100%; padding: 10px; }}
              }}
              
              .news-item {{
                border-bottom: 1px solid #ddd;
                margin-bottom: 20px;
                padding-bottom: 15px;
              }}
              
              .news-item h3 {{ margin: 5px 0; font-size: 18px; }}
              .news-item h3 a {{ color: black; text-decoration: none; }}
              .news-item h3 a:hover {{ text-decoration: underline; }}
              .news-item .date {{ margin: 5px 0; font-size: 12px; color: #666; }}
              .news-item .summary {{ margin: 10px 0; font-size: 14px; line-height: 1.5; }}
              
              .disclaimer {{
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 5px;
                padding: 15px;
                margin: 20px 0;
                font-size: 12px;
                color: #666;
              }}
              
              footer {{ text-align: center; font-size: 12px; margin: 20px 0; }}
            </style>
          </head>
          <body>
            <header>Newsroom</header>
            
            <section class="news-feed">
              <div class="disclaimer">
                â€» ã“ã®ãƒšãƒ¼ã‚¸ã®è¨˜äº‹ã¯ã€AIæŠ€è¡“ã‚’ä½¿ç”¨ã—ã¦è¦ç´„ãƒ»ç·¨é›†ã•ã‚Œã¦ã„ã¾ã™ã€‚
                å…ƒè¨˜äº‹ã®å†…å®¹ã‚’æ­£ç¢ºã«è¡¨ç¾ã™ã‚‹ã‚ˆã†åŠªã‚ã¦ã„ã¾ã™ãŒã€è©³ç´°ã¯å…ƒã‚µã‚¤ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚
              </div>
              
              {news_items}
            </section>
            
            <footer>
              Copyright Â© 2023-2025 Akira Yoshida. | Last updated: {datetime.now().strftime('%Y-%m-%d %H:%M')}
            </footer>
          </body>
          </html>'''
          
          with open('news.html', 'w', encoding='utf-8') as f:
              f.write(html_template)
          
          print("news.html updated successfully")
          EOF
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check if there are any changes to commit
          git add news.html news-data.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Pull latest changes to avoid conflicts
          git pull --rebase origin main || echo "Rebase failed, continuing..."
          
          # Commit and push changes
          git commit -m "Update news with AI summaries

          Auto-generated news summaries using AI

          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

          Co-Authored-By: Claude <noreply@anthropic.com>"
          
          # Push changes with retry
          for i in {1..3}; do
            if git push; then
              echo "Push successful"
              break
            else
              echo "Push failed, retrying in 5 seconds..."
              sleep 5
              git pull --rebase origin main
            fi
          done