name: Update News with AI Summary

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        
      - name: Generate AI-powered news
        env:
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
        run: |
          python3 -c "
          import json, requests, os
          from datetime import datetime
          
          api_key = os.environ.get('HF_API_KEY', '')
          print(f'ğŸ”‘ API Key: {\"âœ…\" if api_key else \"âŒ Missing\"}')
          
          def summarize_with_ai(text):
              if not api_key:
                  return text[:200] + '...'
              try:
                  # æ—¥æœ¬èªå¯¾å¿œã®mT5ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
                  response = requests.post(
                      'https://api-inference.huggingface.co/models/megagonlabs/t5-base-japanese-web-8k',
                      headers={'Authorization': f'Bearer {api_key}'},
                      json={'inputs': f'è¦ç´„: {text[:500]}', 'parameters': {'max_length': 200, 'min_length': 80}},
                      timeout=45
                  )
                  if response.status_code == 200:
                      result = response.json()
                      summary = result[0].get('generated_text', '').strip()
                      if summary and len(summary) > 20:
                          return summary
                      else:
                          print('âš ï¸ Empty summary, using fallback')
                          return text[:200] + '...'
                  print(f'âš ï¸ API Error: {response.status_code}')
                  # APIã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æ—¥æœ¬èªã§ã‚·ãƒ³ãƒ—ãƒ«ãªè¦ç´„ã‚’ä½œæˆ
                  sentences = text.split('ã€‚')
                  if len(sentences) >= 2:
                      return sentences[0] + 'ã€‚' + sentences[1][:50] + 'ã€‚' if len(sentences[1]) > 50 else sentences[0] + 'ã€‚' + sentences[1] + 'ã€‚'
                  return text[:200] + '...'
              except Exception as e:
                  print(f'âš ï¸ AI Error: {e}')
                  # ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æ—¥æœ¬èªã§ã‚·ãƒ³ãƒ—ãƒ«ãªè¦ç´„ã‚’ä½œæˆ
                  sentences = text.split('ã€‚')
                  if len(sentences) >= 2:
                      return sentences[0] + 'ã€‚' + sentences[1][:50] + 'ã€‚' if len(sentences[1]) > 50 else sentences[0] + 'ã€‚' + sentences[1] + 'ã€‚'
                  return text[:200] + '...'
          
          # Sample news with longer content
          news_data = [
              {
                  'title': 'AIæŠ€è¡“ã®æœ€æ–°å‹•å‘ã¨ç¤¾ä¼šã¸ã®å½±éŸ¿',
                  'content': '2025å¹´ã«å…¥ã‚Šã€AIæŠ€è¡“ã®ç™ºå±•ã¯æ–°ãŸãªæ®µéšã‚’è¿ãˆã¦ã„ã¾ã™ã€‚ç‰¹ã«è‡ªç„¶è¨€èªå‡¦ç†åˆ†é‡ã§ã¯ã€å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã®ç²¾åº¦å‘ä¸Šã«ã‚ˆã‚Šã€ã‚ˆã‚Šäººé–“ã‚‰ã—ã„å¯¾è©±ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚ä¼æ¥­ã§ã¯æ¥­å‹™åŠ¹ç‡åŒ–ã®ãŸã‚ã®AIå°å…¥ãŒåŠ é€Ÿã—ã€è£½é€ æ¥­ã€é‡‘èæ¥­ã€åŒ»ç™‚åˆ†é‡ã§ã®å®Ÿç”¨åŒ–ãŒé€²ã‚“ã§ã„ã¾ã™ã€‚ä¸€æ–¹ã§ã€AIå€«ç†ã‚„ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã®è­°è«–ã‚‚æ´»ç™ºåŒ–ã—ã¦ãŠã‚Šã€é©åˆ‡ãªè¦åˆ¶ã¨ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒ©ãƒ³ã‚¹ãŒé‡è¦ãªèª²é¡Œã¨ãªã£ã¦ã„ã¾ã™ã€‚',
                  'link': '#ai-tech'
              },
              {
                  'title': 'æŒç¶šå¯èƒ½ãªé–‹ç™ºç›®æ¨™ã¨ä¼æ¥­ã®å–ã‚Šçµ„ã¿',
                  'content': 'å›½é€£ã®æŒç¶šå¯èƒ½ãªé–‹ç™ºç›®æ¨™ï¼ˆSDGsï¼‰é”æˆã«å‘ã‘ã¦ã€ä¸–ç•Œä¸­ã®ä¼æ¥­ãŒç©æ¥µçš„ãªå–ã‚Šçµ„ã¿ã‚’å±•é–‹ã—ã¦ã„ã¾ã™ã€‚å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®å°å…¥ã€å¾ªç’°å‹çµŒæ¸ˆã®æ¨é€²ã€ç¤¾ä¼šçš„è²¬ä»»æŠ•è³‡ã®æ‹¡å¤§ãªã©ã€å¤šå²ã«ã‚ãŸã‚‹æ–½ç­–ãŒå®Ÿæ–½ã•ã‚Œã¦ã„ã¾ã™ã€‚ç‰¹ã«æ—¥æœ¬ä¼æ¥­ã§ã¯ã€ã‚«ãƒ¼ãƒœãƒ³ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«å®Ÿç¾ã«å‘ã‘ãŸæŠ€è¡“é–‹ç™ºã¨æŠ•è³‡ãŒåŠ é€Ÿã—ã¦ãŠã‚Šã€ã‚°ãƒªãƒ¼ãƒ³æŠ€è¡“åˆ†é‡ã§ã®å›½éš›ç«¶äº‰åŠ›å¼·åŒ–ãŒæœŸå¾…ã•ã‚Œã¦ã„ã¾ã™ã€‚æ¶ˆè²»è€…ã®ç’°å¢ƒæ„è­˜ã®é«˜ã¾ã‚Šã‚‚ä¼æ¥­è¡Œå‹•ã®å¤‰åŒ–ã‚’å¾ŒæŠ¼ã—ã—ã¦ã„ã¾ã™ã€‚',
                  'link': '#sustainability'
              }
          ]
          
          # Process with AI
          processed = []
          for item in news_data:
              summary = summarize_with_ai(item['content'])
              processed.append({
                  'title': item['title'],
                  'summary': summary,
                  'link': item['link'],
                  'pubDate': datetime.now().isoformat(),
                  'processed_at': datetime.now().isoformat()
              })
          
          with open('news-data.json', 'w', encoding='utf-8') as f:
              json.dump(processed, f, ensure_ascii=False, indent=2)
          
          print(f'âœ… Processed {len(processed)} articles with AI')
          "
          
      - name: Create HTML
        run: |
          echo "Creating HTML from AI data..."
          python3 -c "
          import json
          from datetime import datetime
          
          # Load AI-generated data
          with open('news-data.json', 'r', encoding='utf-8') as f:
              news_data = json.load(f)
          
          # Generate HTML with AI summaries
          html = '''<!DOCTYPE html>
          <html lang=\"ja\">
          <head>
            <meta charset=\"UTF-8\">
            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
            <title>Newsroom - Shogo Fun Site</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { font-family: sans-serif; background: white; color: black; }
              header { text-align: center; font-size: 28px; font-weight: bold; margin: 20px 0; }
              .news-feed { width: calc(100% - 20px); max-width: 800px; margin: 0 auto; padding: 20px; }
              .news-item { border-bottom: 1px solid #ddd; margin-bottom: 20px; padding-bottom: 15px; }
              .news-item h3 { margin: 5px 0; font-size: 18px; }
              .news-item h3 a { color: black; text-decoration: none; }
              .news-item .date { margin: 5px 0; font-size: 12px; color: #666; }
              .news-item .summary { margin: 10px 0; font-size: 14px; line-height: 1.5; }
              footer { text-align: center; font-size: 12px; margin: 20px 0; }
            </style>
          </head>
          <body>
            <header>Newsroom</header>
            <section class=\"news-feed\">'''
          
          # Add AI-generated news items
          for item in news_data:
              pub_date = datetime.fromisoformat(item['pubDate']).strftime('%Yå¹´%mæœˆ%dæ—¥')
              html += f'''
              <div class=\"news-item\">
                <h3><a href=\"{item['link']}\">{item['title']}</a></h3>
                <p class=\"date\">{pub_date}</p>
                <p class=\"summary\">{item['summary']}</p>
              </div>'''
          
          html += '''
            </section>
            <footer>Copyright Â© 2023-2025 Akira Yoshida.</footer>
          </body>
          </html>'''
          
          # Write HTML file
          with open('news.html', 'w', encoding='utf-8') as f:
              f.write(html)
          
          print(f'âœ“ Created HTML with {len(news_data)} AI-generated articles')
          "
          echo "âœ“ HTML generation completed"
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add news.html news-data.json
          
          if ! git diff --staged --quiet; then
            git commit -m "Update news ğŸ¤–"
            git push
          else
            echo "No changes"
          fi